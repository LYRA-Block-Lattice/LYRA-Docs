# Fees Disbursement Mechanism

*Design and Technical Specification*

July 2020

LYRA Block Lattice developers

## High Level Design
LYRA transaction fees payments are implemented with two levels of fee aggregation and two-phase distribution mechanism. 
The fees are aggregated at consolidation and service block levels, in order to minimize the network traffic and blockchain growth.
The initial distribution phase, which pays the authorizers, is done by the network protocol.
The second phase, which pays the voters, is responsibility of the authorizers as a part of DPOS design.  

## Lead Authorizer
Lead authorizer (the primary authorizer with the maximum number of votes) is responsible for maintaining the initial fee disbursement mechanism.
If the lead authorizer node is down (not creating a new consolidation block for X minutes and not responding to health messages),
the next primary authorizer (with the next largest amount of votes) becomes the lead authorizer by generating a new service block. The new service block should exclude the “old” lead authorizer from the primary authorizers and include the new authorizer with maximum number of votes from standby authorizers.

## Consolidation Block
Consolidation block has a field Fees which is the summary of the fees for all the blocks consolidated in this block. This can be always validated by the network (and by the primary authorizers that approve the consolidation block) by simple scanning of the blocks that belong to this consolidation cycle.

## Service Block
Service block H also has a field Fees which is a summary of all fees for all consolidation blocks that point to the previous service block H-1 (each consolidation block has “ServiceHash” field). H is the height of the latest service block. The value of Fees can be also validated by the primary authorizers when they approve the service block, and by the network at any time.

Each service block contains the list of current primary authorizers. If the list changes, the new service block must be generated by lead authorizer and approved by the supermajority of the primary authorizers.

The service block also contains fields that define the amount of fee charged to the users.
They can be changed by generating a new service block with a new fee amount. 

New service blocks are generated by lead authorizer at least every 24 hours 
(this is configuration parameter in the service block to be able to debug and adjust), 
or when there are changes in the primary authorizers list or fee settings.     

## Disbursement to Authorizers: ReceiveFee Block 
Once a new service block H is generated, the authorizers that belong to the previous service block H-1 can generate their ReceiveFee blocks,
with the amount A<sub>H</sub> = F/N, where F is the value in Fees field, N is the number of primary authorizers in the H-1 service block.  

ReceiveFee block points to the service block as a source, and signed by the authorizer's key published in the service block H-1
so it can be validated by the primary authorizers.
The node that generates the ReceiveFee block must be in the list of active primary authorizers of the previous service block H-1. 
It doesn't have to be an active primary authorizer in the current service block H because the fees are disbursed for the previous service block’s period.
The ReceiveFee block deposits funds to any account specified by the authorizer. 

## Disbursement to Voters
Each authorizer is responsible for fee disbursement to its voters. 
However, the process is fully automated by the node software and does not require any additional actions from the node owner. 

The authorizer generates regular Send transfer blocks for each voter based on the payment schedule previously advertized.
The authorizer may accumulate fees before disbursement to avoid sending multiple microtransactions. 
The minimum payment amount (accumulation limit) can be set by the authorizer.

The accumulation limit and fee ratio (the part of the fees received by the authorizer that is getting paid to the voters) are advertised in the billboard
and the service block. If the authorizer does follow the payment scheduler or makes wrong calculations, 
the primary authorizers or the voters can disqualify this authorizer (by excluding it from primary authorizers by downvoting). 

The authorizer is responsible for maintaining the internal records for voters which include the following information:
Vote {
Start - consolidation block height S
Amount  - number of votes (LYR amount) A
End - consolidation block height E
Period - service block height (the service block H that contains the fee amount) H
}

This record is included in the authorizer's reporting for each voter.

Amount of fees calculated for the voter:

For each consolidation block from S to E:
calculate a total of votes V from all voters
Calculate a voter’s votes share v = A / V
Calculate a voter’s fees share f = F * v

A total amount of fees paid to the voter for the period H: a<sub>H</sub> = sum (f<sub>S</sub> … f<sub>E</sub>)   
